<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Refund Confirmation</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="../assets/style.css" />
  <style>
    html { padding: 0; margin: 0; width: 100%; height: 100%; overflow: hidden; }
    body { padding: 0; margin: 0; background: var(--bg-primary); width: 100%; min-height: 100%; overflow: hidden; font-family: var(--font-family); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); line-height: 1.7; color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .form-container { width: 100%; padding: 16px; margin: 0; box-sizing: border-box; position: relative; }
    .form-header { margin-bottom: 24px; position: relative; }
    .auto-fill-btn { position: absolute; top: 16px; right: 16px; padding: 8px 16px; background: #007AFF; border: 1px solid #007AFF; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; z-index: 100; }
    .auto-fill-btn:hover { background: #0051D5; border-color: #0051D5; }
    .brand-logo { font-family: var(--font-family-serif); font-size: 28px; font-weight: var(--font-weight-medium); color: #C67C4E; margin-bottom: 8px; letter-spacing: -0.3px; }
    .form-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 8px; }
    .form-intro { font-size: var(--font-size-base); color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; font-style: italic; }
    .admin-section { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--border-radius); }
    .admin-field { display: flex; flex-direction: column; gap: 4px; }
    .admin-field label { font-size: var(--font-size-sm); color: var(--text-secondary); font-weight: var(--font-weight-medium); }
    .admin-field input { padding: 8px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); background: var(--bg-secondary); color: var(--text-primary); cursor: not-allowed; }
    .form-section { margin-bottom: 28px; padding: 0; }
    .section-title { font-size: var(--font-size-lg); font-weight: 700; color: var(--text-primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border-light); }
    .customer-info-grid { display: grid; gap: 16px; margin-bottom: 20px; }
    .info-field { display: flex; flex-direction: column; gap: 6px; }
    .info-field label { font-size: var(--font-size-sm); color: var(--text-secondary); font-weight: var(--font-weight-medium); }
    .info-field input[type="text"], .info-field input[type="email"], .info-field input[type="tel"] { padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); background: var(--bg-primary); width: 100%; box-sizing: border-box; }
    .info-field.readonly input { background: var(--bg-secondary); cursor: not-allowed; }
    .radio-group { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .option-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: var(--font-size-base); color: var(--text-primary); }
    .option-label input { margin: 0; cursor: pointer; }
    .refund-detail-grid { display: grid; gap: 12px; margin-bottom: 12px; }
    .refund-detail-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .refund-detail-row label { font-size: var(--font-size-sm); color: var(--text-secondary); min-width: 100px; }
    .refund-detail-row input[readonly] { flex: 1; min-width: 120px; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--border-radius); cursor: not-allowed; }
    .select-sales-btn { padding: 8px 16px; background: #6c757d; border: 1px solid #5a6268; border-radius: var(--border-radius); color: #fff; font-size: var(--font-size-sm); font-weight: 600; cursor: pointer; }
    .select-sales-btn:hover { background: #5a6268; border-color: #545b62; }
    .reason-textarea { width: 100%; min-height: 80px; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); font-family: inherit; resize: vertical; box-sizing: border-box; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 12px 24px; align-items: flex-start; }
    .checkbox-group .conditional-input { margin-top: 8px; padding-left: 0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .checkbox-group .conditional-input input[type="text"] { padding: 8px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); min-width: 180px; }
    .conditional-input.active { display: flex !important; }
    .conditional-input:not(.active) { display: none !important; }
    .confirmation-line { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .confirmation-line input[type="checkbox"] { margin: 0; flex-shrink: 0; }
    .confirmation-line .amount-inline { display: inline-flex; align-items: center; gap: 6px; margin-left: 4px; }
    .confirmation-line .amount-inline input { width: 100px; padding: 6px 10px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); }
    .signature-section[data-pdf-only="true"] { display: none; }
    @media print { .signature-section[data-pdf-only="true"] { display: block !important; } }
    .signature-label { font-size: var(--font-size-sm); margin-bottom: 4px; }
    .signature-line { min-height: 60px; border-bottom: 2px solid var(--border-color); margin-bottom: 8px; }
    .date-time-group { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px; }
    .date-time-field label { font-size: var(--font-size-sm); color: var(--text-secondary); }
    .date-time-field input { padding: 8px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); background: var(--bg-secondary); }
    .system-note { font-size: var(--font-size-xs); color: var(--text-light); font-style: italic; margin-top: 4px; }
    .required-note { font-size: var(--font-size-xs); color: var(--text-light); margin-top: 12px; font-style: italic; }
    .form-reset-section { margin: 24px 0; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-light); }
    .form-reset-btn { width: 100%; padding: 10px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius); color: var(--text-secondary); font-size: var(--font-size-sm); cursor: pointer; }
    /* Layer popup */
    .refund-layer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    .refund-layer-overlay.open { display: flex; }
    .refund-layer-box { background: var(--bg-primary); border-radius: var(--border-radius); box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 560px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    .refund-layer-header { padding: 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .refund-layer-title { font-size: var(--font-size-lg); font-weight: 600; color: var(--text-primary); }
    .refund-layer-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 4px; line-height: 1; }
    .refund-layer-body { padding: 16px; overflow: auto; flex: 1; }
    .refund-layer-filter { margin-bottom: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .refund-layer-filter label { font-size: var(--font-size-sm); color: var(--text-secondary); }
    .refund-layer-filter input[type="date"] { padding: 8px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: var(--font-size-base); }
    .refund-sales-list { border: 1px solid var(--border-light); border-radius: var(--border-radius); max-height: 280px; overflow: auto; }
    .refund-sales-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.15s; }
    .refund-sales-item:last-child { border-bottom: none; }
    .refund-sales-item:hover { background: var(--bg-secondary); }
    .refund-sales-item.selected { background: rgba(0,122,255,0.1); border-left: 3px solid #007AFF; }
    .refund-sales-item input[type="radio"] { margin: 0; flex-shrink: 0; }
    .refund-sales-item .item-invoice { font-size: var(--font-size-sm); color: var(--text-secondary); }
    .refund-sales-item .item-product { font-weight: 500; color: var(--text-primary); }
    .refund-sales-item .item-price { font-weight: 600; color: var(--text-primary); margin-left: auto; }
    .refund-layer-empty { padding: 24px; text-align: center; color: var(--text-secondary); font-size: var(--font-size-sm); }
  </style>
</head>
<body>
  <div class="form-container">
    <button type="button" class="auto-fill-btn" id="auto-fill-btn" title="Fill sample data">Auto-fill</button>
    <div class="form-header">
      <div class="brand-logo" data-field="brand-name">Sulwhasoo</div>
      <div class="form-title">Customer Refund Confirmation</div>
      <p class="form-intro">Please confirm the refund details and sign below. All amounts are in HKD.</p>
    </div>

    <div class="admin-section">
      <div class="admin-field">
        <label>Store Registration :</label>
        <input type="text" readonly data-field="store-registration" value="" />
      </div>
      <div class="admin-field">
        <label>Responsible Staff :</label>
        <input type="text" readonly data-field="responsible-staff" value="" />
      </div>
    </div>

    <!-- Customer Information -->
    <div class="form-section">
      <div class="section-title">Customer Information</div>
      <div class="customer-info-grid">
        <div class="info-field">
          <label>Name:</label>
          <input type="text" id="customer-name" readonly data-field="customer-name" value="" />
        </div>
        <div class="info-field">
          <label>Title:</label>
          <div class="radio-group">
            <label class="option-label">
              <input type="radio" name="title" value="Ms" disabled />
              <span>Ms.</span>
            </label>
            <label class="option-label">
              <input type="radio" name="title" value="Mrs" disabled />
              <span>Mrs.</span>
            </label>
            <label class="option-label">
              <input type="radio" name="title" value="Mr" disabled />
              <span>Mr.</span>
            </label>
          </div>
        </div>
        <div class="info-field">
          <label>Membership Number:</label>
          <input type="text" id="membership-number" readonly data-field="membership-number" value="" />
        </div>
        <div class="info-field">
          <label>Contact Number:</label>
          <div class="radio-group" style="margin-bottom: 8px;">
            <label class="option-label">
              <input type="radio" name="country-code" value="852" disabled />
              <span>852</span>
            </label>
            <label class="option-label">
              <input type="radio" name="country-code" value="853" disabled />
              <span>853</span>
            </label>
            <label class="option-label">
              <input type="radio" name="country-code" value="86" disabled />
              <span>86</span>
            </label>
          </div>
          <input type="tel" id="contact-number" readonly data-field="contact-number" value="" placeholder="Enter phone number" />
        </div>
        <div class="info-field">
          <label>Email:</label>
          <input type="email" id="email" readonly data-field="email" value="" placeholder="Enter email address" />
        </div>
        <div class="info-field">
          <label>Member Grade:</label>
          <input type="text" id="member-grade" readonly data-field="member-grade" value="" />
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Refund Details</div>
      <div class="refund-detail-grid">
        <div class="refund-detail-row">
          <label>Invoice No :</label>
          <input type="text" readonly id="refund-invoice-no" data-field="refund-invoice-no" value="" />
          <label>Invoice Date :</label>
          <input type="text" readonly id="refund-invoice-date" data-field="refund-invoice-date" value="" />
        </div>
        <div class="refund-detail-row">
          <label>Refund Amount (HKD) :</label>
          <input type="text" readonly id="refund-amount" data-field="refund-amount" value="" />
          <button type="button" class="select-sales-btn" id="select-sales-btn">Select from Sales</button>
        </div>
        <div class="refund-detail-row">
          <label>Returned Product :</label>
          <input type="text" readonly id="refund-returned-product" data-field="refund-returned-product" value="" placeholder="Select a sale above" />
        </div>
        <div class="info-field">
          <label>Reason for return :</label>
          <textarea id="reason-for-return" data-field="reason-for-return" class="reason-textarea" placeholder="Enter reason for return"></textarea>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Refund Method</div>
      <div class="checkbox-group">
        <label class="option-label"><input type="checkbox" name="refund-method" value="Cash" /><span>Cash</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="VISA" /><span>VISA</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="MASTER" /><span>MASTER</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="AE" /><span>AE</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="CUP" /><span>CUP</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="WeChat Pay" /><span>WeChat Pay</span></label>
        <label class="option-label"><input type="checkbox" name="refund-method" value="AliPay" /><span>AliPay</span></label>
        <div class="conditional-input" id="refund-method-other-wrap">
          <label class="option-label" style="margin: 0;">
            <input type="checkbox" name="refund-method" value="Other" id="refund-method-other-cb" />
            <span>Other</span>
          </label>
          <input type="text" id="refund-method-other-input" data-field="refund-method-other" placeholder="please specify" />
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Confirmation</div>
      <div class="confirmation-line">
        <input type="checkbox" id="confirm-cash" name="confirm-cash" />
        <label for="confirm-cash">I confirm receipt of cash refund of HKD $</label>
        <span class="amount-inline"><input type="text" id="confirm-cash-amount" data-field="confirm-cash-amount" placeholder="0.00" /></span>
      </div>
      <div class="confirmation-line">
        <input type="checkbox" id="confirm-original" name="confirm-original" />
        <label for="confirm-original">I confirm that refund of HKD $</label>
        <span class="amount-inline"><input type="text" id="confirm-original-amount" data-field="confirm-original-amount" placeholder="0.00" /></span>
        <span> will be made to my original payment method.</span>
      </div>
      <div class="signature-section" style="display: none;" data-pdf-only="true">
        <div class="signature-label">Signature * : <span class="required">(Required)</span></div>
        <div class="signature-line" data-field="signature-image" style="min-height: 60px; display: flex; align-items: center; justify-content: center; padding: 8px; color: var(--text-light); font-size: var(--font-size-sm); font-style: italic;">Signature will be injected during PDF generation</div>
        <div class="date-time-group">
          <div class="date-time-field">
            <label>Date : Year / Month / Day</label>
            <input type="text" readonly data-field="signature-date" id="signature-date" value="" />
            <div class="system-note">(System generated)</div>
          </div>
          <div class="date-time-field">
            <label>Time :</label>
            <input type="text" readonly data-field="signature-time" id="signature-time" value="" />
            <div class="system-note">(System generated)</div>
          </div>
        </div>
        <div class="required-note">* Required field</div>
      </div>
    </div>

    <div class="form-reset-section">
      <button type="button" id="form-reset-btn" class="form-reset-btn">Reset Form</button>
    </div>
  </div>

  <!-- Refund detail layer popup -->
  <div class="refund-layer-overlay" id="refund-layer-overlay">
    <div class="refund-layer-box">
      <div class="refund-layer-header">
        <span class="refund-layer-title">Select from Sales (Refund Item)</span>
        <button type="button" class="refund-layer-close" id="refund-layer-close" aria-label="Close">&times;</button>
      </div>
      <div class="refund-layer-body">
        <div class="refund-layer-filter">
          <label for="refund-layer-date">Business Date :</label>
          <input type="date" id="refund-layer-date" />
        </div>
        <div class="refund-sales-list" id="refund-sales-list"></div>
        <div style="margin-top: 12px; text-align: right;">
          <button type="button" class="select-sales-btn" id="refund-layer-confirm-btn">Confirm Selection</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var formKey = 'customer-refund';

      function sendHeightToParent() {
        var height = Math.max(document.body.scrollHeight, document.body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'iframe-resize', height: height }, '*');
        }
      }

      function getSalesByDate(dateStr) {
        var sales = (window.parent && window.parent.HKPOS && window.parent.HKPOS.SAMPLE_SALES) || (window.HKPOS && window.HKPOS.SAMPLE_SALES) || [];
        if (!dateStr) return sales;
        return sales.filter(function(item) { return item.date === dateStr; });
      }

      function formatDateDisplay(iso) {
        if (!iso) return '';
        var p = iso.split('-');
        return p.length === 3 ? p[2] + '-' + p[1] + '-' + p[0] : iso;
      }

      function formatAmountDisplay(num) {
        if (num == null || num === '') return '';
        var n = Number(num);
        if (isNaN(n)) return String(num);
        var parts = n.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return parts.join('.');
      }

      function renderSalesList() {
        var dateInput = document.getElementById('refund-layer-date');
        var listEl = document.getElementById('refund-sales-list');
        var dateStr = dateInput ? dateInput.value : '';
        var items = getSalesByDate(dateStr);
        listEl.innerHTML = '';
        if (items.length === 0) {
          listEl.innerHTML = '<div class="refund-layer-empty">No sales data for this date. Please select another date.</div>';
          return;
        }
        items.forEach(function(item, idx) {
          var row = document.createElement('div');
          row.className = 'refund-sales-item';
          row.setAttribute('data-index', idx);
          row.innerHTML = '<input type="radio" name="refund-layer-select" value="' + idx + '" />' +
            '<div><div class="item-invoice">' + (item.invoiceNo || '') + ' &nbsp; ' + (item.date || '') + '</div>' +
            '<div class="item-product">' + (item.productInfo || item.productCode || '') + '</div></div>' +
            '<div class="item-price">HKD ' + (item.price != null ? formatAmountDisplay(item.price) : '0.00') + '</div>';
          row.addEventListener('click', function() {
            var radio = row.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            document.querySelectorAll('.refund-sales-item').forEach(function(r) { r.classList.remove('selected'); });
            row.classList.add('selected');
          });
          listEl.appendChild(row);
        });
      }

      function applySelectedSale(item) {
        document.getElementById('refund-invoice-no').value = item.invoiceNo || '';
        document.getElementById('refund-invoice-date').value = formatDateDisplay(item.date) || '';
        document.getElementById('refund-amount').value = item.price != null ? formatAmountDisplay(item.price) : '';
        document.getElementById('refund-returned-product').value = (item.productCode || '') + ' ' + (item.productInfo || '');
        document.getElementById('refund-returned-product').setAttribute('data-raw', JSON.stringify(item));
      }

      function collectFormData() {
        var formData = {};
        var set = function(key) {
          var el = document.querySelector('[data-field="' + key + '"]') || document.getElementById(key);
          if (el && el.value !== undefined) formData[key] = (el.value || '').trim();
        };
        set('store-registration');
        set('responsible-staff');
        set('customer-name');
        set('membership-number');
        set('contact-number');
        set('email');
        set('refund-invoice-no');
        set('refund-invoice-date');
        set('refund-amount');
        set('refund-returned-product');
        set('reason-for-return');
        set('confirm-cash-amount');
        set('confirm-original-amount');
        set('signature-date');
        set('signature-time');
        set('refund-method-other');
        var titleRadio = document.querySelector('input[name="title"]:checked');
        formData['title'] = titleRadio ? titleRadio.value : '';
        var ccRadio = document.querySelector('input[name="country-code"]:checked');
        formData['country-code'] = ccRadio ? ccRadio.value : '';
        var refundMethods = [];
        document.querySelectorAll('input[name="refund-method"]:checked').forEach(function(cb) {
          var v = cb.value;
          if (v === 'Other') {
            var otherInput = document.getElementById('refund-method-other-input');
            if (otherInput && otherInput.value.trim()) refundMethods.push('Other: ' + otherInput.value.trim());
            else refundMethods.push('Other');
          } else {
            refundMethods.push(v);
          }
        });
        formData['refund-method'] = refundMethods;
        formData['confirm-cash'] = !!(document.getElementById('confirm-cash') && document.getElementById('confirm-cash').checked);
        formData['confirm-original'] = !!(document.getElementById('confirm-original') && document.getElementById('confirm-original').checked);
        return formData;
      }

      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'form-data-request') {
          var formData = collectFormData();
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'form-data-collected', formKey: formKey, data: formData }, '*');
          }
          return;
        }
        if (event.data && event.data.type === 'form-data-inject') {
          var data = event.data.data || {};
          var set = function(selector, val) {
            var el = document.querySelector(selector);
            if (el && val != null && val !== '') el.value = val;
          };
          var setRadio = function(name, val) {
            var el = document.querySelector('input[name="' + name + '"][value="' + (val || '') + '"]');
            if (el) el.checked = true;
          };
          set('[data-field="store-registration"]', data['store-registration']);
          set('[data-field="responsible-staff"]', data['responsible-staff']);
          set('[data-field="customer-name"]', data['customer-name']);
          set('[data-field="membership-number"]', data['membership-number']);
          set('[data-field="contact-number"]', data['contact-number']);
          set('#contact-number', data['contact-number']);
          set('[data-field="email"]', data['email']);
          set('#email', data['email']);
          set('#signature-date', data['signature-date']);
          set('#signature-time', data['signature-time']);
          setRadio('title', data['title']);
          setRadio('country-code', data['country-code']);
          if (data['refund-invoice-no'] != null) set('#refund-invoice-no', data['refund-invoice-no']);
          if (data['refund-invoice-date'] != null) set('#refund-invoice-date', data['refund-invoice-date']);
          if (data['refund-amount'] != null) {
            var amtVal = data['refund-amount'];
            var formatted = formatAmountDisplay(amtVal);
            set('#refund-amount', formatted !== '' ? formatted : amtVal);
          }
          if (data['refund-returned-product'] != null) set('#refund-returned-product', data['refund-returned-product']);
          if (data['reason-for-return'] != null) set('#reason-for-return', data['reason-for-return']);
          var brandName = data['brand-name'] || 'Sulwhasoo';
          var brandEl = document.querySelector('[data-field="brand-name"]');
          if (brandEl) {
            var logoFilename = data['brand-logo-filename'];
            if (logoFilename) {
              var img = new Image();
              var logoUrl = '../assets/images/' + logoFilename;
              img.onload = function() {
                brandEl.style.backgroundImage = 'url(' + logoUrl + ')';
                brandEl.style.backgroundSize = '170px 75px';
                brandEl.style.backgroundRepeat = 'no-repeat';
                brandEl.style.backgroundPosition = '';
                brandEl.textContent = '';
                brandEl.style.height = '75px';
              };
              img.onerror = function() {
                brandEl.textContent = data['brand-name'] || 'Sulwhasoo';
                brandEl.style.backgroundImage = '';
                brandEl.style.backgroundSize = '';
              };
              img.src = logoUrl;
            } else if (data['brand-name']) {
              brandEl.textContent = data['brand-name'];
              brandEl.style.backgroundImage = '';
              brandEl.style.backgroundSize = '';
            }
          }
          setTimeout(sendHeightToParent, 100);
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        var now = new Date();
        var dateStr = String(now.getFullYear()) + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        var layerDateDefault = '2026-01-30'; // demo: match SAMPLE_SALES
        var dateEl = document.getElementById('signature-date');
        var timeEl = document.getElementById('signature-time');
        if (dateEl && !dateEl.value) dateEl.value = formatDateDisplay(dateStr);
        if (timeEl && !timeEl.value) timeEl.value = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

        var layerDate = document.getElementById('refund-layer-date');
        if (layerDate && !layerDate.value) layerDate.value = layerDateDefault;
        layerDate.addEventListener('change', renderSalesList);

        document.getElementById('select-sales-btn').addEventListener('click', function() {
          if (layerDate && !layerDate.value) layerDate.value = layerDateDefault;
          renderSalesList();
          document.getElementById('refund-layer-overlay').classList.add('open');
        });
        document.getElementById('refund-layer-close').addEventListener('click', function() {
          document.getElementById('refund-layer-overlay').classList.remove('open');
        });
        document.getElementById('refund-layer-overlay').addEventListener('click', function(e) {
          if (e.target === this) this.classList.remove('open');
        });
        document.getElementById('refund-sales-list').addEventListener('click', function(e) {
          var itemRow = e.target.closest('.refund-sales-item');
          if (!itemRow) return;
          var radio = itemRow.querySelector('input[name="refund-layer-select"]');
          if (radio) radio.checked = true;
          document.querySelectorAll('.refund-sales-item').forEach(function(r) { r.classList.remove('selected'); });
          itemRow.classList.add('selected');
        });
        document.getElementById('refund-layer-confirm-btn').addEventListener('click', function() {
          var radio = document.querySelector('#refund-sales-list input[name="refund-layer-select"]:checked');
          if (!radio) return;
          var dateStr2 = document.getElementById('refund-layer-date').value;
          var items = getSalesByDate(dateStr2);
          var idx = parseInt(radio.value, 10);
          if (items[idx]) {
            applySelectedSale(items[idx]);
            document.getElementById('refund-layer-overlay').classList.remove('open');
            sendHeightToParent();
          }
        });

        var otherCb = document.getElementById('refund-method-other-cb');
        var otherWrap = document.getElementById('refund-method-other-wrap');
        if (otherCb && otherWrap) {
          otherWrap.classList.toggle('active', otherCb.checked);
          otherCb.addEventListener('change', function() {
            otherWrap.classList.toggle('active', this.checked);
            sendHeightToParent();
          });
        }

        var refundAmountEl = document.getElementById('refund-amount');
        var confirmCash = document.getElementById('confirm-cash');
        var confirmCashAmount = document.getElementById('confirm-cash-amount');
        var confirmOriginal = document.getElementById('confirm-original');
        var confirmOriginalAmount = document.getElementById('confirm-original-amount');
        function syncConfirmAmounts() {
          var amt = refundAmountEl && refundAmountEl.value ? refundAmountEl.value.trim() : '';
          if (confirmCash && confirmCash.checked && amt) confirmCashAmount.value = amt;
          if (confirmOriginal && confirmOriginal.checked && amt) confirmOriginalAmount.value = amt;
        }
        confirmCash.addEventListener('change', function() {
          if (!this.checked) confirmCashAmount.value = '';
          else syncConfirmAmounts();
          sendHeightToParent();
        });
        confirmOriginal.addEventListener('change', function() {
          if (!this.checked) confirmOriginalAmount.value = '';
          else syncConfirmAmounts();
          sendHeightToParent();
        });
        if (refundAmountEl) refundAmountEl.addEventListener('input', syncConfirmAmounts);

        function formatAmountInputOnBlur(el) {
          if (!el || !el.value) return;
          var trimmed = el.value.trim().replace(/,/g, '');
          var n = Number(trimmed);
          if (!isNaN(n)) el.value = formatAmountDisplay(n);
        }
        var confirmCashAmountEl = document.getElementById('confirm-cash-amount');
        var confirmOriginalAmountEl = document.getElementById('confirm-original-amount');
        if (confirmCashAmountEl) confirmCashAmountEl.addEventListener('blur', function() { formatAmountInputOnBlur(this); });
        if (confirmOriginalAmountEl) confirmOriginalAmountEl.addEventListener('blur', function() { formatAmountInputOnBlur(this); });

        document.getElementById('auto-fill-btn').addEventListener('click', function() {
          var titleRadio = document.querySelector('input[name="title"]');
          if (titleRadio) titleRadio.checked = true;
          var ccRadio = document.querySelector('input[name="country-code"]');
          if (ccRadio) ccRadio.checked = true;
          if (layerDate && !layerDate.value) layerDate.value = dateStr;
          renderSalesList();
          var items = getSalesByDate(layerDate ? layerDate.value : dateStr);
          if (items.length > 0) {
            applySelectedSale(items[0]);
          }
          document.getElementById('reason-for-return').value = 'Product not as expected.';
          document.querySelector('input[name="refund-method"][value="Cash"]').checked = true;
          confirmCash.checked = true;
          confirmOriginal.checked = true;
          syncConfirmAmounts();
          sendHeightToParent();
        });

        document.getElementById('form-reset-btn').addEventListener('click', function() {
          if (confirm('양식을 초기화하시겠습니까? 입력한 모든 데이터가 삭제됩니다.')) {
            document.getElementById('refund-invoice-no').value = '';
            document.getElementById('refund-invoice-date').value = '';
            document.getElementById('refund-amount').value = '';
            document.getElementById('refund-returned-product').value = '';
            document.getElementById('refund-returned-product').removeAttribute('data-raw');
            document.getElementById('reason-for-return').value = '';
            document.querySelectorAll('input[name="refund-method"]').forEach(function(cb) { cb.checked = false; });
            document.getElementById('refund-method-other-input').value = '';
            if (otherWrap) otherWrap.classList.remove('active');
            confirmCash.checked = false;
            confirmOriginal.checked = false;
            confirmCashAmount.value = '';
            confirmOriginalAmount.value = '';
            if (dateEl) dateEl.value = formatDateDisplay(dateStr);
            if (timeEl) timeEl.value = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
            if (layerDate) layerDate.value = layerDateDefault;
            setTimeout(sendHeightToParent, 100);
          }
        });

        sendHeightToParent();
        setTimeout(sendHeightToParent, 300);
        var observer = new MutationObserver(function() { sendHeightToParent(); });
        observer.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['style', 'class'] });
        window.addEventListener('resize', sendHeightToParent);
      });
    })();
  </script>
</body>
</html>
